# üèóÔ∏è Plan Architecture Database Compl√®te

## √âtat Actuel ‚ùå
- **Stockage**: En m√©moire (List<User>)
- **Persistence**: Aucune (perdu au red√©marrage)
- **Multi-PC**: Impossible
- **Sync**: Aucune

---

## Architecture Cible ‚úÖ

### 1. Frontend (Flutter + Drift)

#### Fichiers √† Cr√©er
```
lib/src/core/database/
‚îú‚îÄ‚îÄ app_database.dart          ‚Üê Drift database definition
‚îú‚îÄ‚îÄ app_database.g.dart        ‚Üê Generated by Drift
‚îî‚îÄ‚îÄ tables/
    ‚îú‚îÄ‚îÄ users_table.dart       ‚Üê User table schema
    ‚îî‚îÄ‚îÄ templates_table.dart   ‚Üê Template table schema

lib/src/features/users/data/
‚îú‚îÄ‚îÄ dao/
‚îÇ   ‚îú‚îÄ‚îÄ users_dao.dart         ‚Üê Data Access Object for users
‚îÇ   ‚îî‚îÄ‚îÄ templates_dao.dart     ‚Üê Data Access Object for templates
‚îú‚îÄ‚îÄ users_repository.dart      ‚Üê Updated to use Drift
‚îî‚îÄ‚îÄ sync/
    ‚îî‚îÄ‚îÄ users_sync_service.dart ‚Üê gRPC sync logic
```

#### Dependencies (pubspec.yaml)
```yaml
dependencies:
  drift: ^2.14.0
  sqlite3_flutter_libs: ^0.5.0
  path_provider: ^2.1.0
  path: ^1.8.0
  
dev_dependencies:
  drift_dev: ^2.14.0
  build_runner: ^2.4.0
```

---

### 2. Backend (Go + PostgreSQL)

#### Structure Serveur
```
medicore_server/
‚îú‚îÄ‚îÄ main.go                    ‚Üê Entry point
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ config.go              ‚Üê Configuration (DB, ports)
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ postgres.go            ‚Üê PostgreSQL connection
‚îÇ   ‚îî‚îÄ‚îÄ migrations/            ‚Üê SQL migration files
‚îÇ       ‚îú‚îÄ‚îÄ 001_users.sql
‚îÇ       ‚îî‚îÄ‚îÄ 002_templates.sql
‚îú‚îÄ‚îÄ models/
‚îÇ   ‚îú‚îÄ‚îÄ user.go                ‚Üê User model
‚îÇ   ‚îî‚îÄ‚îÄ template.go            ‚Üê Template model
‚îú‚îÄ‚îÄ repository/
‚îÇ   ‚îú‚îÄ‚îÄ users_repository.go    ‚Üê PostgreSQL queries
‚îÇ   ‚îî‚îÄ‚îÄ templates_repository.go
‚îú‚îÄ‚îÄ grpc/
‚îÇ   ‚îú‚îÄ‚îÄ server.go              ‚Üê gRPC server setup
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îî‚îÄ‚îÄ users_service.go   ‚Üê Users gRPC implementation
‚îî‚îÄ‚îÄ proto/
    ‚îî‚îÄ‚îÄ users.proto            ‚Üê gRPC contract definition
```

#### Go Dependencies (go.mod)
```go
require (
    github.com/lib/pq v1.10.9              // PostgreSQL driver
    google.golang.org/grpc v1.59.0         // gRPC
    google.golang.org/protobuf v1.31.0     // Protobuf
    github.com/joho/godotenv v1.5.1        // Environment config
)
```

---

### 3. Database Schema

#### PostgreSQL (Server)
```sql
-- users table
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    role VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    percentage DECIMAL(5,2),
    is_template_user BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    
    -- Sync fields
    last_synced_at TIMESTAMP,
    sync_version INTEGER DEFAULT 1
);

-- templates table
CREATE TABLE templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    role VARCHAR(100) NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    percentage DECIMAL(5,2) NOT NULL,
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    deleted_at TIMESTAMP,
    
    -- Sync fields
    last_synced_at TIMESTAMP,
    sync_version INTEGER DEFAULT 1
);

-- Indexes
CREATE INDEX idx_users_name ON users(name);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_templates_role ON templates(role);
```

#### SQLite/Drift (Client)
```dart
// users_table.dart
class Users extends Table {
  TextColumn get id => text()();
  TextColumn get name => text()();
  TextColumn get role => text()();
  TextColumn get passwordHash => text()();
  RealColumn get percentage => real().nullable()();
  BoolColumn get isTemplateUser => boolean()();
  DateTimeColumn get createdAt => dateTime()();
  DateTimeColumn get updatedAt => dateTime()();
  DateTimeColumn get deletedAt => dateTime().nullable()();
  
  // Sync fields
  DateTimeColumn get lastSyncedAt => dateTime().nullable()();
  IntColumn get syncVersion => integer().withDefault(const Constant(1))();
  BoolColumn get needsSync => boolean().withDefault(const Constant(false))();
  
  @override
  Set<Column> get primaryKey => {id};
}
```

---

### 4. Sync Strategy (Sync-First Architecture)

#### Flow de Donn√©es
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Flutter App (Client)            ‚îÇ
‚îÇ                                         ‚îÇ
‚îÇ  1. User creates/edits data             ‚îÇ
‚îÇ     ‚Üì                                   ‚îÇ
‚îÇ  2. Save to SQLite (Drift) IMMEDIATELY  ‚îÇ ‚Üê Instant, offline-first
‚îÇ     ‚Üì                                   ‚îÇ
‚îÇ  3. Mark as "needs_sync = true"         ‚îÇ
‚îÇ     ‚Üì                                   ‚îÇ
‚îÇ  4. Background sync service triggers    ‚îÇ
‚îÇ     ‚Üì                                   ‚îÇ
‚îÇ  5. Send to server via gRPC             ‚îÇ
‚îÇ     ‚Üì                                   ‚îÇ
‚îÇ  6. Server saves to PostgreSQL          ‚îÇ
‚îÇ     ‚Üì                                   ‚îÇ
‚îÇ  7. Server returns confirmation         ‚îÇ
‚îÇ     ‚Üì                                   ‚îÇ
‚îÇ  8. Update "last_synced_at" in SQLite   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

#### Conflict Resolution
```dart
// R√®gles de r√©solution
1. Server wins by default (most recent timestamp)
2. Local changes have "sync_version" incremented
3. If versions conflict:
   - Compare updated_at timestamps
   - Server timestamp > Local timestamp ‚Üí Server wins
   - Local timestamp > Server timestamp ‚Üí Upload local
   - Same timestamp ‚Üí Prompt user (rare)
```

---

### 5. gRPC API Contract

#### users.proto
```protobuf
syntax = "proto3";

package medicore.users;

// User message
message User {
  string id = 1;
  string name = 2;
  string role = 3;
  string password_hash = 4;
  optional double percentage = 5;
  bool is_template_user = 6;
  int64 created_at = 7;
  int64 updated_at = 8;
  optional int64 deleted_at = 9;
  int32 sync_version = 10;
}

// Template message
message UserTemplate {
  string id = 1;
  string role = 2;
  string password_hash = 3;
  double percentage = 4;
  int64 created_at = 5;
  int64 updated_at = 6;
  optional int64 deleted_at = 7;
  int32 sync_version = 8;
}

// Sync request
message SyncUsersRequest {
  int64 last_sync_timestamp = 1;
  repeated User local_changes = 2;
}

// Sync response
message SyncUsersResponse {
  repeated User server_updates = 1;
  repeated string deleted_ids = 2;
  int64 server_timestamp = 3;
}

// Users service
service UsersService {
  rpc SyncUsers(SyncUsersRequest) returns (SyncUsersResponse);
  rpc CreateUser(User) returns (User);
  rpc UpdateUser(User) returns (User);
  rpc DeleteUser(DeleteUserRequest) returns (DeleteUserResponse);
  rpc GetAllUsers(GetUsersRequest) returns (GetUsersResponse);
}
```

---

### 6. Configuration

#### Client (Flutter)
```dart
// lib/src/core/config/app_config.dart
class AppConfig {
  // Server connection
  static const String serverHost = 'localhost'; // or IP
  static const int serverPort = 50051;
  static const bool useTLS = false; // true for cloud
  
  // Sync settings
  static const Duration syncInterval = Duration(minutes: 5);
  static const int maxRetries = 3;
  static const Duration retryDelay = Duration(seconds: 10);
  
  // Database
  static const String dbName = 'medicore.db';
}
```

#### Server (Go)
```go
// config/config.go
type Config struct {
    ServerPort     int    `env:"SERVER_PORT" default:"50051"`
    DatabaseURL    string `env:"DATABASE_URL" required:"true"`
    EnableTLS      bool   `env:"ENABLE_TLS" default:"false"`
    TLSCertPath    string `env:"TLS_CERT_PATH"`
    TLSKeyPath     string `env:"TLS_KEY_PATH"`
}
```

#### Environment (.env)
```bash
# Server Configuration
SERVER_PORT=50051
DATABASE_URL=postgres://user:pass@localhost:5432/medicore

# For Cloud/Production
ENABLE_TLS=true
TLS_CERT_PATH=/path/to/cert.pem
TLS_KEY_PATH=/path/to/key.pem
```

---

### 7. D√©ploiement

#### Option A: LAN (Local Network)
```bash
# PC Admin (Server)
1. Installer PostgreSQL
2. Run: ./medicore_server (Go binary)
3. Le serveur √©coute sur: 192.168.1.100:50051

# PC Clients
1. Installer l'app Flutter
2. Configuration: Pointer vers 192.168.1.100:50051
3. Sync automatique avec le serveur
```

#### Option B: Cloud
```bash
# Cloud Server (AWS/DigitalOcean/etc)
1. Deploy Go backend + PostgreSQL
2. Configurer HTTPS/TLS
3. Ouvrir port 50051 (ou 443 avec gRPC-Web)

# Clients (Anywhere)
1. Configuration: Pointer vers server.medicore.com:50051
2. Sync via Internet
```

---

### 8. Migration des Donn√©es Actuelles

```dart
// Migration script
Future<void> migrateInMemoryToDatabase() async {
  final db = await AppDatabase().database;
  final oldRepo = UsersRepository(); // In-memory
  
  // Migrate users
  for (var user in oldRepo.getAllUsers()) {
    await db.usersDao.insertUser(user);
  }
  
  // Migrate templates
  for (var template in oldRepo.getAllTemplates()) {
    await db.templatesDao.insertTemplate(template);
  }
}
```

---

## üìã Checklist d'Impl√©mentation

### Phase 1: Database Locale (Drift) ‚úÖ
- [ ] Ajouter dependencies Drift
- [ ] Cr√©er tables (users, templates)
- [ ] Cr√©er DAOs (Data Access Objects)
- [ ] Mettre √† jour repository pour utiliser Drift
- [ ] Tester persistence locale
- [ ] Migrer donn√©es en m√©moire ‚Üí SQLite

### Phase 2: Backend Go ‚úÖ
- [ ] Initialiser projet Go
- [ ] Configurer PostgreSQL
- [ ] Cr√©er migrations SQL
- [ ] Impl√©menter repositories Go
- [ ] D√©finir proto gRPC
- [ ] G√©n√©rer code gRPC (Go + Dart)
- [ ] Impl√©menter services gRPC

### Phase 3: Sync ‚úÖ
- [ ] Cr√©er SyncService dans Flutter
- [ ] Impl√©menter sync logic (up/down)
- [ ] Gestion des conflits
- [ ] Sync automatique en background
- [ ] UI pour statut sync (ic√¥ne)
- [ ] Gestion erreurs r√©seau

### Phase 4: D√©ploiement ‚úÖ
- [ ] Compiler Go server en binaire
- [ ] Package Flutter app
- [ ] Configuration LAN/Cloud
- [ ] Tests multi-PC
- [ ] Documentation d√©ploiement

---

## ‚è±Ô∏è Estimation de Temps

| Phase | Temps | Priorit√© |
|-------|-------|----------|
| Phase 1 (Drift local) | 2-3h | HAUTE |
| Phase 2 (Go backend) | 4-6h | HAUTE |
| Phase 3 (Sync) | 3-4h | MOYENNE |
| Phase 4 (Deploy) | 1-2h | BASSE |
| **TOTAL** | **10-15h** | - |

---

## üéØ Recommandation

**Je recommande de faire Phase 1 MAINTENANT**:
1. Impl√©mente Drift/SQLite local
2. Les donn√©es persistent
3. Pas besoin de serveur encore
4. Vous pouvez tester les features
5. Pr√©pare pour sync plus tard

**Puis Phase 2+3 quand vous √™tes pr√™t pour multi-PC**

Voulez-vous que je commence par Phase 1 (Drift/SQLite) ?
