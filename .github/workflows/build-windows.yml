name: Build MediCore Windows Universal Installer

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get dependencies
        working-directory: medicore_app
        run: flutter pub get

      # Proto generation disabled - using local database for now
      # TODO: Re-enable when gRPC client is properly implemented

      - name: Build Windows x64 Release
        working-directory: medicore_app
        run: flutter build windows --release

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build Go gRPC/REST Server
        working-directory: medicore_server
        run: |
          go mod tidy
          $env:CGO_ENABLED = "1"
          go build -o ../medicore_app/build/windows/x64/runner/Release/medicore_server.exe ./cmd/server/main.go
        shell: powershell

      - name: Download VC++ Redistributables
        run: |
          New-Item -ItemType Directory -Force -Path "medicore_app/installer/vcredist"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "medicore_app/installer/vcredist/vc_redist.x64.exe"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x86.exe" -OutFile "medicore_app/installer/vcredist/vc_redist.x86.exe"
        shell: powershell

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
        shell: powershell

      - name: Build Universal Installer
        run: |
          New-Item -ItemType Directory -Force -Path "medicore_app/build/installer"
          $env:PATH = "C:\Program Files (x86)\Inno Setup 6;$env:PATH"
          iscc "medicore_app/installer/windows_universal_installer.iss"
        shell: powershell

      - name: Create Portable ZIP (no installer)
        run: |
          $buildPath = "medicore_app/build/windows/x64/runner/Release"
          Copy-Item "medicore_app/installer/vcredist/vc_redist.x64.exe" "$buildPath/"
          Copy-Item "medicore_app/installer/vcredist/vc_redist.x86.exe" "$buildPath/"
          
          @"
          MediCore - Portable Version
          ============================
          
          INSTALLATION:
          1. Extract all files to a folder
          2. Run vc_redist.x64.exe (only once, ever)
          3. If error persists, run vc_redist.x86.exe too
          4. Run medicore_app.exe
          
          FIRST USE:
          - Choose ADMIN on main computer (with database)
          - Choose CLIENT on other computers
          - Clients auto-detect admin on network
          
          This is the portable version. No installation required!
          Works on Windows 7, 8, 8.1, 10, 11 (64-bit)
          "@ | Out-File -FilePath "$buildPath/README.txt" -Encoding UTF8
          
          New-Item -ItemType Directory -Force -Path "medicore_app/build/installer"
          Compress-Archive -Path "$buildPath/*" -DestinationPath "medicore_app/build/installer/MediCore-Portable.zip" -Force
        shell: powershell

      - name: Upload Universal Installer
        uses: actions/upload-artifact@v4
        with:
          name: MediCore-Setup-Universal
          path: medicore_app/build/installer/MediCore-Setup-Universal.exe

      - name: Upload Portable ZIP
        uses: actions/upload-artifact@v4
        with:
          name: MediCore-Portable
          path: medicore_app/build/installer/MediCore-Portable.zip
