name: Build MediCore Windows

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get dependencies
        working-directory: medicore_app
        run: flutter pub get

      - name: Enable Web Support
        working-directory: medicore_app
        run: flutter create . --platforms=web

      - name: Build Windows 64-bit (Native)
        working-directory: medicore_app
        run: flutter build windows --release

      - name: Build Flutter Web (For 32-bit wrapper)
        working-directory: medicore_app
        run: flutter build web --web-renderer html --release

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Build 32-bit Web Wrapper
        run: |
          # Copy web build to wrapper
          New-Item -ItemType Directory -Force -Path "medicore_app/web_wrapper/web"
          Copy-Item -Path "medicore_app/build/web/*" -Destination "medicore_app/web_wrapper/web/" -Recurse -Force
          
          # Initialize Go module if not exists
          cd medicore_app/web_wrapper
          if (-not (Test-Path "go.mod")) {
            go mod init medicore/wrapper
          }
          
          # Build 32-bit wrapper
          $env:GOOS = "windows"
          $env:GOARCH = "386"
          $env:CGO_ENABLED = "0"
          go build -ldflags="-s -w" -o medicore_32bit.exe main.go
          
          # Build 64-bit wrapper too
          $env:GOARCH = "amd64"
          go build -ldflags="-s -w" -o medicore_64bit_web.exe main.go
        shell: powershell

      - name: Download VC++ Redistributables
        run: |
          New-Item -ItemType Directory -Force -Path "medicore_app/installer/vcredist"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "medicore_app/installer/vcredist/vc_redist.x64.exe"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x86.exe" -OutFile "medicore_app/installer/vcredist/vc_redist.x86.exe"
        shell: powershell

      - name: Create Packages (Both 32-bit and 64-bit)
        run: |
          # ====== 64-BIT NATIVE PACKAGE ======
          $buildPath64 = "medicore_app/build/windows/x64/runner/Release"
          New-Item -ItemType Directory -Force -Path "medicore_app/build/package_64bit"
          
          Copy-Item -Path "$buildPath64/*" -Destination "medicore_app/build/package_64bit/" -Recurse -Force
          Copy-Item "medicore_app/installer/vcredist/vc_redist.x64.exe" "medicore_app/build/package_64bit/"
          Copy-Item "medicore_app/installer/vcredist/vc_redist.x86.exe" "medicore_app/build/package_64bit/"
          
          # ====== 32-BIT WEB WRAPPER PACKAGE ======
          New-Item -ItemType Directory -Force -Path "medicore_app/build/package_32bit"
          
          Copy-Item "medicore_app/web_wrapper/medicore_32bit.exe" "medicore_app/build/package_32bit/MediCore.exe"
          Copy-Item "medicore_app/installer/vcredist/vc_redist.x86.exe" "medicore_app/build/package_32bit/"
          
          # 64-BIT LAUNCHER
          @"
          @echo off
          chcp 65001 >nul
          echo Installation...
          vc_redist.x64.exe /install /quiet /norestart 2>nul
          vc_redist.x86.exe /install /quiet /norestart 2>nul
          start "" medicore_app.exe
          exit
          "@ | Out-File -FilePath "medicore_app/build/package_64bit/DEMARRER.bat" -Encoding UTF8
          
          # 32-BIT LAUNCHER
          @"
          @echo off
          chcp 65001 >nul
          echo Installation...
          vc_redist.x86.exe /install /quiet /norestart 2>nul
          start "" MediCore.exe
          exit
          "@ | Out-File -FilePath "medicore_app/build/package_32bit/DEMARRER.bat" -Encoding UTF8
          
          # Create README
          @"
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                 MEDICORE - INSTALLATION SIMPLE               â•‘
          â•‘          SystÃ¨me de Gestion MÃ©dicale pour Cabinet            â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CONFIGURATION REQUISE:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Windows 7, 8, 10, 11 (VERSION 64-BIT SEULEMENT)
          âŒ Ne fonctionne PAS sur Windows 32-bit (architecture x86)
          
          â†’ Pour vÃ©rifier: Ordinateur â†’ PropriÃ©tÃ©s â†’ "SystÃ¨me d'exploitation 64 bits"
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          INSTALLATION EN 3 Ã‰TAPES:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Ã‰TAPE 1: Extraire le ZIP
          -------------------------
          Extraire tous les fichiers dans un dossier (ex: C:\MediCore)
          
          Ã‰TAPE 2: Autoriser l'application
          ---------------------------------
          Windows SmartScreen ou Antivirus vont BLOQUER l'app.
          C'EST NORMAL! L'app n'est pas signÃ©e (coÃ»te 300â‚¬/an).
          
          ğŸ‘‰ Windows SmartScreen:
             1. Clic droit sur DEMARRER.bat â†’ "ExÃ©cuter en tant qu'administrateur"
             2. Si alerte: "Informations complÃ©mentaires" â†’ "ExÃ©cuter quand mÃªme"
          
          ğŸ‘‰ Avira / Avast / Windows Defender:
             1. Ouvrir l'antivirus â†’ ParamÃ¨tres â†’ Exclusions
             2. Ajouter le dossier C:\MediCore complet
             3. Recommencer
          
          Ã‰TAPE 3: Lancer
          ----------------
          Double-clic sur: DEMARRER.bat
          
          OU MANUEL:
          1. Double-clic: vc_redist.x64.exe (installer)
          2. Double-clic: vc_redist.x86.exe (installer)
          3. Double-clic: medicore_app.exe
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PREMIÃˆRE UTILISATION - CHOIX ADMIN OU CLIENT:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Au dÃ©marrage, l'app demande:
          
          ğŸ–¥ï¸  ADMIN â†’ Ordinateur principal avec la base de donnÃ©es
             â€¢ Importez votre fichier .db
             â€¢ Cet ordi diffuse sur le rÃ©seau
          
          ğŸ’» CLIENT â†’ Autres ordinateurs
             â€¢ DÃ©tecte automatiquement l'Admin
             â€¢ Cliquez pour connecter
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PROBLÃˆMES FRÃ‰QUENTS:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âŒ "Ne peut pas dÃ©marrer, MSVCP140.dll manquant"
             â†’ Lancez DEMARRER.bat en admin (clic droit)
          
          âŒ "L'app ne dÃ©marre pas sur Windows 7/8"
             â†’ VÃ©rifiez: c'est bien Windows 64-bit?
             â†’ Si 32-bit: impossible, l'app ne peut pas fonctionner
          
          âŒ "CLIENT ne trouve pas ADMIN"
             â†’ MÃªme rÃ©seau WiFi/LAN?
             â†’ Pare-feu Windows: autoriser medicore_app.exe
          
          âŒ "Antivirus supprime l'app"
             â†’ Ajouter aux exclusions (c'est une fausse alerte)
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          POURQUOI 64-BIT SEULEMENT?
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Flutter (la technologie utilisÃ©e) ne supporte QUE le 64-bit
          pour Windows. Ce n'est pas un choix, c'est une limitation
          technique.
          
          ~95% des PC depuis 2010 sont 64-bit. Les PC 32-bit sont trÃ¨s
          rares maintenant.
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          MediCore v1.0 - 2025
                  https://github.com/ilyesthen/medicore
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          "@ | Out-File -FilePath "medicore_app/build/package_64bit/LISEZ-MOI.txt" -Encoding UTF8
          
          # 32-BIT README
          @"
          MediCore 32-bit (Windows 7/8/10/11)
          ===================================
          
          Cette version fonctionne sur Windows 32-bit!
          
          INSTALLATION:
          1. Double-clic sur DEMARRER.bat
          2. L'app s'ouvre dans votre navigateur
          
          NOTE: Cette version utilise votre navigateur web.
          Performance lÃ©gÃ¨rement infÃ©rieure Ã  la version 64-bit native.
          
          "@ | Out-File -FilePath "medicore_app/build/package_32bit/LISEZ-MOI.txt" -Encoding UTF8
          
          # Create ZIPs
          Compress-Archive -Path "medicore_app/build/package_64bit/*" -DestinationPath "medicore_app/build/MediCore-Windows-64bit.zip" -Force
          Compress-Archive -Path "medicore_app/build/package_32bit/*" -DestinationPath "medicore_app/build/MediCore-Windows-32bit.zip" -Force
        shell: powershell

      - name: Upload 64-bit Package
        uses: actions/upload-artifact@v4
        with:
          name: MediCore-Windows-64bit
          path: medicore_app/build/MediCore-Windows-64bit.zip

      - name: Upload 32-bit Package
        uses: actions/upload-artifact@v4
        with:
          name: MediCore-Windows-32bit
          path: medicore_app/build/MediCore-Windows-32bit.zip
