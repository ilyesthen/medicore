name: Build MediCore Windows

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get dependencies
        working-directory: medicore_app
        run: flutter pub get

      - name: Build Windows Release
        working-directory: medicore_app
        run: flutter build windows --release

      - name: Download VC++ Redistributables
        run: |
          New-Item -ItemType Directory -Force -Path "medicore_app/installer/vcredist"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "medicore_app/installer/vcredist/vc_redist.x64.exe"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x86.exe" -OutFile "medicore_app/installer/vcredist/vc_redist.x86.exe"
        shell: powershell

      - name: Create Simple Package
        run: |
          $buildPath = "medicore_app/build/windows/x64/runner/Release"
          New-Item -ItemType Directory -Force -Path "medicore_app/build/package"
          
          # Copy all app files
          Copy-Item -Path "$buildPath/*" -Destination "medicore_app/build/package/" -Recurse -Force
          
          # Copy VC++ redistributables
          Copy-Item "medicore_app/installer/vcredist/vc_redist.x64.exe" "medicore_app/build/package/"
          Copy-Item "medicore_app/installer/vcredist/vc_redist.x86.exe" "medicore_app/build/package/"
          
          # Create INSTALL.bat
          @"
          @echo off
          echo ========================================
          echo MediCore Installation
          echo ========================================
          echo.
          echo Installing required components...
          echo.
          
          REM Install VC++ Redistributables silently
          vc_redist.x64.exe /install /quiet /norestart
          if exist vc_redist.x86.exe vc_redist.x86.exe /install /quiet /norestart
          
          echo.
          echo Installation complete!
          echo Starting MediCore...
          echo.
          start medicore_app.exe
          "@ | Out-File -FilePath "medicore_app/build/package/INSTALL.bat" -Encoding ASCII
          
          # Create README
          @"
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                    MEDICORE - INSTALLATION                   â•‘
          â•‘          SystÃ¨me de Gestion MÃ©dicale pour Cabinet           â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âš ï¸  IMPORTANT - LISEZ CECI D'ABORD âš ï¸
          ========================================
          
          SI WINDOWS BLOQUE L'APPLICATION:
          --------------------------------
          1. Windows peut afficher "Windows a protÃ©gÃ© votre PC"
          2. Cliquez sur "Informations complÃ©mentaires"
          3. Puis cliquez "ExÃ©cuter quand mÃªme"
          
          C'EST NORMAL! L'application n'est pas signÃ©e numÃ©riquement.
          Elle est 100% sÃ»re.
          
          SI ANTIVIRUS BLOQUE (Avira, Avast, etc.):
          -----------------------------------------
          1. Ouvrez votre antivirus
          2. Ajoutez le dossier MediCore aux EXCLUSIONS
          3. RedÃ©marrez l'installation
          
          
          ğŸ“¥ INSTALLATION RAPIDE:
          ======================
          
          MÃ©thode 1 - AUTOMATIQUE (RecommandÃ©):
          -------------------------------------
          âœ Double-cliquez sur: INSTALL.bat
          âœ Cliquez "Oui" si Windows demande l'autorisation
          âœ L'application dÃ©marre automatiquement
          
          MÃ©thod 2 - MANUELLE:
          -------------------
          1. Double-cliquez vc_redist.x64.exe â†’ Installez
          2. Double-cliquez vc_redist.x86.exe â†’ Installez (si nÃ©cessaire)
          3. Double-cliquez medicore_app.exe
          
          
          ğŸš€ PREMIÃˆRE UTILISATION:
          ========================
          
          L'application vous demandera de choisir:
          
          ğŸ–¥ï¸  ADMIN (Ordinateur Principal):
              âœ“ Choisissez ceci sur UN SEUL ordinateur
              âœ“ Importez votre base de donnÃ©es (.db)
              âœ“ Les autres ordinateurs se connecteront Ã  celui-ci
          
          ğŸ’» CLIENT (Autres Ordinateurs):
              âœ“ Choisissez ceci sur tous les autres postes
              âœ“ L'Admin sera dÃ©tectÃ© automatiquement
              âœ“ Cliquez dessus pour vous connecter
          
          
          ğŸ”§ DÃ‰PANNAGE:
          =============
          
          âŒ "MSVCP140.dll manquant":
             â†’ ExÃ©cutez INSTALL.bat en tant qu'administrateur
             â†’ OU installez les deux vc_redist manuellement
          
          âŒ Le CLIENT ne trouve pas l'ADMIN:
             â†’ VÃ©rifiez que les deux PC sont sur le mÃªme rÃ©seau WiFi/LAN
             â†’ DÃ©sactivez temporairement le pare-feu pour tester
             â†’ Sur l'Admin, autorisez medicore_app.exe dans le pare-feu
          
          âŒ Windows SmartScreen bloque:
             â†’ Normal! Cliquez "Informations complÃ©mentaires"
             â†’ Puis "ExÃ©cuter quand mÃªme"
          
          âŒ Antivirus bloque (fausse alerte):
             â†’ Ajoutez le dossier aux exclusions de l'antivirus
             â†’ OU dÃ©sactivez temporairement l'antivirus
          
          
          ğŸ’¡ CONFIGURATION SYSTÃˆME:
          =========================
          Compatible: Windows 7, 8, 8.1, 10, 11 (64-bit)
          RÃ©seau: WiFi ou cÃ¢ble Ethernet
          Port utilisÃ©: 50051 (TCP/UDP)
          
          
          ğŸ“§ SUPPORT:
          ===========
          GitHub: https://github.com/ilyesthen/medicore
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          MediCore v1.0 - 2025
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          "@ | Out-File -FilePath "medicore_app/build/package/LISEZ-MOI.txt" -Encoding UTF8
          
          # Create ZIP
          Compress-Archive -Path "medicore_app/build/package/*" -DestinationPath "medicore_app/build/MediCore-Windows.zip" -Force
        shell: powershell

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: MediCore-Windows
          path: medicore_app/build/MediCore-Windows.zip
