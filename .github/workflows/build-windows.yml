name: Build MediCore Windows

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get dependencies
        working-directory: medicore_app
        run: flutter pub get

      - name: Build Windows x64 Release
        working-directory: medicore_app
        run: flutter build windows --release

      - name: Download VC++ Redistributables (both x64 and x86)
        run: |
          $buildPath = "medicore_app/build/windows/x64/runner/Release"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "$buildPath/vc_redist.x64.exe"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x86.exe" -OutFile "$buildPath/vc_redist.x86.exe"
        shell: powershell

      - name: Create README
        run: |
          $buildPath = "medicore_app/build/windows/x64/runner/Release"
          @"
          MediCore - Medical Management System
          =====================================
          Version: Windows 64-bit
          Compatible: Windows 7, 8, 8.1, 10, 11 (64-bit)
          
          IMPORTANT - FIRST TIME INSTALLATION:
          ====================================
          If you get "MSVCP140.dll is missing" error:
          
          1. Run vc_redist.x64.exe FIRST (only needed once)
          2. If that doesn't work, also run vc_redist.x86.exe
          3. Click "Install" on both and wait for completion
          4. Then run medicore_app.exe
          
          Note: Both redistributables are included for maximum compatibility.
          Most systems only need x64, but some require both.
          
          SETUP INSTRUCTIONS:
          ===================
          First time you run the app, you will choose:
          
          ADMIN (Main Computer):
          - Select this on ONE computer that has the database
          - Click "Sélectionner le fichier .db" 
          - Choose your database file
          - Click "DÉMARRER COMME ADMIN"
          - This computer will broadcast to the network
          
          CLIENT (Other Computers):
          - Select this on all other computers
          - Click "Rechercher le serveur Admin"
          - Wait 5 seconds - the Admin will appear automatically
          - Click on the Admin server to connect
          
          All clients will work on the same database through your local network!
          
          TROUBLESHOOTING:
          ================
          - Client can't find Admin? 
            * Make sure they're on the same WiFi/LAN network
            * Check Windows Firewall - allow medicore_app.exe
            * Make sure Admin computer is running and setup is complete
          
          - MSVCP140.dll error persists?
            * Run both vc_redist files as Administrator
            * Restart your computer after installation
          
          - Admin not broadcasting?
            * Restart the Admin application
            * Check firewall settings
          
          Support: github.com/ilyesthen/medicore
          
          "@  | Out-File -FilePath "$buildPath/README.txt" -Encoding UTF8
        shell: powershell

      - name: Upload Build
        uses: actions/upload-artifact@v4
        with:
          name: MediCore-Windows-x64
          path: medicore_app/build/windows/x64/runner/Release/
