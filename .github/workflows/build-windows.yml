name: Build MediCore Windows

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'

      - name: Get dependencies
        working-directory: medicore_app
        run: flutter pub get

      - name: Build Windows Release
        working-directory: medicore_app
        run: flutter build windows --release

      - name: Download VC++ Redistributables
        run: |
          New-Item -ItemType Directory -Force -Path "medicore_app/installer/vcredist"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x64.exe" -OutFile "medicore_app/installer/vcredist/vc_redist.x64.exe"
          Invoke-WebRequest -Uri "https://aka.ms/vs/17/release/vc_redist.x86.exe" -OutFile "medicore_app/installer/vcredist/vc_redist.x86.exe"
        shell: powershell

      - name: Create Simple Package
        run: |
          $buildPath = "medicore_app/build/windows/x64/runner/Release"
          New-Item -ItemType Directory -Force -Path "medicore_app/build/package"
          
          # Copy all app files
          Copy-Item -Path "$buildPath/*" -Destination "medicore_app/build/package/" -Recurse -Force
          
          # Copy VC++ redistributables
          Copy-Item "medicore_app/installer/vcredist/vc_redist.x64.exe" "medicore_app/build/package/"
          Copy-Item "medicore_app/installer/vcredist/vc_redist.x86.exe" "medicore_app/build/package/"
          
          # Create smart launcher that detects 32-bit vs 64-bit
          @"
          @echo off
          chcp 65001 >nul
          cls
          
          REM Check if running on 32-bit or 64-bit Windows
          if defined PROCESSOR_ARCHITEW6432 goto :64bit
          if "%PROCESSOR_ARCHITECTURE%"=="AMD64" goto :64bit
          if "%PROCESSOR_ARCHITECTURE%"=="x86_64" goto :64bit
          
          REM 32-bit Windows detected - show error
          :32bit
          color 4F
          cls
          echo.
          echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          echo â•‘                    âš ï¸  ERREUR SYSTEME  âš ï¸                    â•‘
          echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo.
          echo  MediCore necessite Windows 64-bit
          echo.
          echo  Votre ordinateur utilise Windows 32-bit (x86)
          echo  Cette version ne peut PAS executer MediCore
          echo.
          echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo  POURQUOI?
          echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo.
          echo  La technologie Flutter ne supporte QUE le 64-bit sur Windows
          echo  Ce n'est pas un bug - c'est une limitation technique
          echo.
          echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo  SOLUTIONS:
          echo  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo.
          echo  1. Utiliser un autre ordinateur avec Windows 64-bit
          echo  2. Mettre a niveau vers Windows 64-bit
          echo  3. Acheter un PC moderne (tous sont 64-bit depuis 2010)
          echo.
          echo  Pour verifier: Ordinateur -^> Proprietes
          echo                 Cherchez "Type du systeme"
          echo.
          pause
          exit
          
          REM 64-bit Windows - proceed with installation
          :64bit
          cls
          echo.
          echo â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          echo â•‘              MEDICORE - DEMARRAGE RAPIDE              â•‘
          echo â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          echo.
          echo âœ“ Windows 64-bit detecte - Compatible!
          echo.
          echo Installation des composants requis...
          
          vc_redist.x64.exe /install /quiet /norestart 2>nul
          if %errorlevel% neq 0 (
            echo   Installation VC++ x64 - Deja installe ou erreur
          ) else (
            echo âœ“ VC++ x64 installe
          )
          
          vc_redist.x86.exe /install /quiet /norestart 2>nul
          if %errorlevel% neq 0 (
            echo   Installation VC++ x86 - Deja installe ou erreur
          ) else (
            echo âœ“ VC++ x86 installe
          )
          
          echo.
          echo âœ“ Installation terminee!
          echo.
          echo Demarrage de MediCore...
          timeout /t 2 >nul
          
          REM Check if app exists
          if not exist medicore_app.exe (
            color 4F
            echo.
            echo âŒ ERREUR: medicore_app.exe introuvable!
            echo.
            pause
            exit
          )
          
          start "" medicore_app.exe
          exit
          "@ | Out-File -FilePath "medicore_app/build/package/DEMARRER.bat" -Encoding UTF8
          
          # Create README
          @"
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘                 MEDICORE - INSTALLATION SIMPLE               â•‘
          â•‘          SystÃ¨me de Gestion MÃ©dicale pour Cabinet            â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CONFIGURATION REQUISE:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âœ… Windows 7, 8, 10, 11 (VERSION 64-BIT SEULEMENT)
          âŒ Ne fonctionne PAS sur Windows 32-bit (architecture x86)
          
          â†’ Pour vÃ©rifier: Ordinateur â†’ PropriÃ©tÃ©s â†’ "SystÃ¨me d'exploitation 64 bits"
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          INSTALLATION EN 3 Ã‰TAPES:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Ã‰TAPE 1: Extraire le ZIP
          -------------------------
          Extraire tous les fichiers dans un dossier (ex: C:\MediCore)
          
          Ã‰TAPE 2: Autoriser l'application
          ---------------------------------
          Windows SmartScreen ou Antivirus vont BLOQUER l'app.
          C'EST NORMAL! L'app n'est pas signÃ©e (coÃ»te 300â‚¬/an).
          
          ğŸ‘‰ Windows SmartScreen:
             1. Clic droit sur DEMARRER.bat â†’ "ExÃ©cuter en tant qu'administrateur"
             2. Si alerte: "Informations complÃ©mentaires" â†’ "ExÃ©cuter quand mÃªme"
          
          ğŸ‘‰ Avira / Avast / Windows Defender:
             1. Ouvrir l'antivirus â†’ ParamÃ¨tres â†’ Exclusions
             2. Ajouter le dossier C:\MediCore complet
             3. Recommencer
          
          Ã‰TAPE 3: Lancer
          ----------------
          Double-clic sur: DEMARRER.bat
          
          OU MANUEL:
          1. Double-clic: vc_redist.x64.exe (installer)
          2. Double-clic: vc_redist.x86.exe (installer)
          3. Double-clic: medicore_app.exe
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PREMIÃˆRE UTILISATION - CHOIX ADMIN OU CLIENT:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Au dÃ©marrage, l'app demande:
          
          ğŸ–¥ï¸  ADMIN â†’ Ordinateur principal avec la base de donnÃ©es
             â€¢ Importez votre fichier .db
             â€¢ Cet ordi diffuse sur le rÃ©seau
          
          ğŸ’» CLIENT â†’ Autres ordinateurs
             â€¢ DÃ©tecte automatiquement l'Admin
             â€¢ Cliquez pour connecter
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          PROBLÃˆMES FRÃ‰QUENTS:
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          âŒ "Ne peut pas dÃ©marrer, MSVCP140.dll manquant"
             â†’ Lancez DEMARRER.bat en admin (clic droit)
          
          âŒ "L'app ne dÃ©marre pas sur Windows 7/8"
             â†’ VÃ©rifiez: c'est bien Windows 64-bit?
             â†’ Si 32-bit: impossible, l'app ne peut pas fonctionner
          
          âŒ "CLIENT ne trouve pas ADMIN"
             â†’ MÃªme rÃ©seau WiFi/LAN?
             â†’ Pare-feu Windows: autoriser medicore_app.exe
          
          âŒ "Antivirus supprime l'app"
             â†’ Ajouter aux exclusions (c'est une fausse alerte)
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          POURQUOI 64-BIT SEULEMENT?
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          Flutter (la technologie utilisÃ©e) ne supporte QUE le 64-bit
          pour Windows. Ce n'est pas un choix, c'est une limitation
          technique.
          
          ~95% des PC depuis 2010 sont 64-bit. Les PC 32-bit sont trÃ¨s
          rares maintenant.
          
          
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                          MediCore v1.0 - 2025
                  https://github.com/ilyesthen/medicore
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          "@ | Out-File -FilePath "medicore_app/build/package/LISEZ-MOI.txt" -Encoding UTF8
          
          # Create ZIP
          Compress-Archive -Path "medicore_app/build/package/*" -DestinationPath "medicore_app/build/MediCore-Windows.zip" -Force
        shell: powershell

      - name: Upload Package
        uses: actions/upload-artifact@v4
        with:
          name: MediCore-Windows
          path: medicore_app/build/MediCore-Windows.zip
